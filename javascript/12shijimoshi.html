<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" href="../index.css">
    <script>

//        message:{
//              event1 : [ fn, fn1, fn2... ],
//              event2 : [ fn, fn1, fn2... ],
//        }

//         DATA:{
//
//              a:computed
//              b:computed
//
//          }

//        data:{//要监听的对象，也是参数
//            a:"12"
//            b:"13"
//        }
        function observer(data){
            var message = {};//用于存放事件及函数
            var DATA = {}; //用于对应存放计算属性
            var PATH = "";

            //objName对象订阅消息:{objName1:fn，objName1:fn1}
            var addListen = function(msg,fn){
                if(!message[msg]){
                   message[msg] = [];
                }
                   message[msg].push(fn);
            };
            var removeListen = function(msg){//取消订阅
                if(!message[msg]){
                    console.error("没有注册的消息");
                    return false;
                }
                delete message[msg];
            };
            var trigger = function(msg,info){//发布消息
                if(!message[msg]){
                    console.error("没有注册的消息");
                    return false;
                }
                for(var i= 0,len=message[msg].length;i<len;i++){
                    message[msg][i](info);
                }
            };

            //在DATA中定义对应data同名属性的计算属性
            var definedComputed = function(DATA,data,attr,path){
                Object.defineProperty(DATA,attr,{
                    configurable:true,
                    enumerable:true,
                    get:function(){
                        return data[attr];
                    },
                    set:function(newValue){
                        if(newValue!==data[attr]){//值改变时，触发绑定在属性上的事件函数
                                path = path.slice(1);
                                trigger(path,[data[attr],newValue]);
                                data[attr] = newValue;
                        }
                    }
                })
            };

            var defineComputedOne = function(DATA, o, attr, path ){
                Object.defineProperty(DATA,attr,{
                    configurable:true,
                    enumerable:true,
                    get:function(){
                        return o;
                    },
                    set:function(newValue){
                        if(newValue!==o){//值改变时，触发绑定在属性上的事件函数
                            path = path.slice(1);
                            alert(path)//???空
                            trigger(path,[o,newValue]);
                            o = newValue;
                        }
                    }

                })
            }

            //遍历data，将data的属性军设为计算属性
            var toComputed = function(DATA,data){
                for(attr in data){
                    var _attr = function(attr){
                        return attr; //闭包，解决attr的值总是最后一个的问题
                    }(attr);

                    PATH += "."+_attr;

                    //alert("1"+PATH);
                    if(typeof(data[attr])==="object"){
                            var o = {};
                            toComputed(o,data[attr]);
                            //DATA[_attr] = o
                            defineComputedOne(DATA, o, _attr, PATH)
                    }else{
                        definedComputed(DATA,data,_attr,PATH);
                        PATH = "";
                    }
                }
            };

            toComputed(DATA, data);

            return {
                addListen:addListen,
                removeListen:removeListen,
                trigger:trigger,
                $data:DATA
            }
        }

        var myObserver = observer({
            a:12,
            b:"hsdf",
            c:{
                cc:"ffhgfh"
            }
        });
        myObserver.addListen("c",function(){
            alert("a变了")
        })
        //myObserver.$data.c = 13;
        //alert(myObserver.$data.c.cc)
        alert(JSON.stringify(myObserver.$data))

    </script>
</head>
<body >
<div class="box">
    <h3>1、最简单的实现就是用一个对象存储一些方法，在特定的时候掉用方法即可。</h3>
    <pre>
        message:{
             event1 : [ fn, fn1, fn2... ],
             event2 : [ fn, fn1, fn2... ],
        }


        function observer(){
            var message = {};//用于存放事件及函数

            //objName对象订阅消息:{objName1:fn，objName1:fn1}
            var addListen = function(msg,fn){
                if(!message[msg]){
                   message[msg] = [];
                }
                   message[msg].push(fn);
            };
            var removeListen = function(msg){//取消订阅
                if(!message[msg]){
                    console.error("没有注册的消息");
                    return false;
                }
                delete message[msg];
            };
            var trigger = function(msg,info){//发布消息
                if(!message[msg]){
                    console.error("没有注册的消息");
                    return false;
                }
                for(var i= 0,len=message[msg].length;i<len;i++){
                    message[msg][i](info);
                }
            };

            return {
                addListen:addListen,
                removeListen:removeListen,
                trigger:trigger
            }
        }

        var myObserver = observer();

        myObserver.addListen("haha",function(msg){
            alert(msg);
        });

        myObserver.addListen("haha",function(msg){
            alert(msg);
        });

        myObserver.trigger("haha","nihao");

    </pre>
</div>

<div class="box">`
    <h3>2、观察者和计算属性结合</h3>
    <ol>
        <li>
            这个例子通过计算属性来触发事件。只能浅度检测。
        </li>
    </ol>
</div>


</body>
</html>