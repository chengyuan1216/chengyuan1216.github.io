<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" href="../index.css">
    <script src="../jquery.min.js"></script>
</head>
<body >
<div class="box">
    <h3>什么是Deferred对象</h3>
    <p>
        是对promise的实现。 <br/>
        它是非同步操作的通用接口，可以被看做是一个等待完成的人任务，开发者通过一些通用的接口对齐进行设置。<br/><br/>

        promise是什么？<br/>
        解决了异步操作回调函数的一些问题。<br/>
        它的核心思想就是让异步操作返回一个对象，其他操作都针对这个对象来完成。<br/>
    </p>
    <pre>
        function doSomethingLater(fn,time){
            var dfd = $.Deferred();

            setTimeout(function(){
                dfd.resolve(fn());
            },time||0);

            return  dfd.promise();
        }

        var pro = doSomethingLater(function(){
            alert("延迟两秒")
        },2000)
    </pre>

    <h3>$.deferred()</h3>
    <p>
        作用：<br/>
        生成一个dferred对象。
    </p>
    <pre>
        var dfd = $.Deferred();
    </pre>


    <h3>dfd.done()、dfd.fail()</h3>
    <p>
        作用：<br/>
        这两个方法都用来绑定回调函数。<br/>
        done()非同步操作成功后执行的回调函数。<br/>
        fail()非同步操作失败后执行的回调函数。
    </p>
    <pre>
        var dfd = $.Deferred();
        dfd.done(function(){
            alert(0);//不执行，因为dfd的状态没有改变
        });
        alert(1);
    </pre>



    <h3>dfd.resolve()、dfd.reject()</h3>
    <p>
        作用：<br/>
        这两个方法用来改变dfd对象的状态,并且可以将参数传递给回调函数。<br/>
        resolve()将状态改为非同步操作成功状态。<br/>
        reject()将状态改为非同步操作失败状态。<br/>
        如果是成功状态，一次执行done()和then()。<br/>
        如果是失败状态，一次执行fail()和then()。
    </p>

    <pre>
        var dfd = $.Deferred();

        dfd.done(function(val){
            alert(val);
        });

        //可控制回调函数何时执行
        dfd.resolve("hello dfd");

        //不执行，状态改变后将不能在改变
        dfd.reject("fail");

    </pre>

    <h3>dfd.state()</h3>
    <p>
        作用：<br/>
        返dfd对象当前的状态。<br/>
        三种状态：<br/>
        pending表示操作未完成<br/>
        resolved表示操作成功<br/>
        rejected表示操作失败<br/>
    </p>
    <pre>
        var dfd = $.Deferred();
        //alert(dfd.state());//pending状态

        //dfd.resolve();
        //alert(dfd.state());//resolved

        //dfd.reject();
        //alert(dfd.state());//rejected

    </pre>

    <h3>dfd.notify()、dfd.progress()</h3>
    <p>
        作用：<br/>
        progress()用来指定一个回调函数，当调用notify()方法时，该函数将执行。<br/>
        用意是提供一个接口使得在非同步操作执行的过程中，可以执行某些操作。<br/>
        比如定期返回进度条的进度。<br/>
    </p>

    <h3>then()</h3>
    <p>
        作用：<br/>
        也是用于指定回调函数。<br/>
        他可以指定三个参数，也就是三个回调函数。<br/>
        第一个是resolve的回调函数<br/>
        第二个是reject的回调函数<br/>
        第三个是progress的回调函数<br/><br/>

        用法;<br/>
        1、then()返回一个新的dfd对象。<br/>
        2、回调函数的返回值将会作为参数传入后面的回调函数,从一个dfd对象到另一个dfd对象。<br/>
        3、怎样在回调函数内部引用dfd对象。<br/>
    </p>

    <pre>
        var dfd = $.Deferred();

        dfd.done(function(a,b){

            console.log( dfd.state() );//resolved
            console.log(a,b);//2,3
            return a*b;

        }).done(function(r){

            console.log( dfd.state() );//resolved
            console.log(r);// 2
            //这里是r就是a,同一个dfd对象不会将return值传递

        }).then(function(a,b){
            console.log( dfd.state() );//resolved
            console.log(a,b);//2,3
            return  a*b;//6
            //执行完then后返回一个新的dfd对象，并且将返回值传递给新的对象

        }).done(function(r,a,b){

            console.log(r,a,b);//6,undefined,undefined

        });

        dfd.resolve(2,3);

    </pre>

    <h3>always()</h3>
    <p>
        作用：<br/>
        也是指定回调函数，不管是成功还是失败状态都执行。<br/>
    </p>

    <h3>pipe()</h3>
    <p>
        作用：<br/>
        也是指定回调函数，表示在调用then、done 、fail、 always 之前调用。<br/>
        通常用来对服务器返回的数据做初步处理。<br/>
    </p>


    <h3>promise对象</h3>
    <p>
        作用：<br/>
        大多数情况下，我们不想让用户从外部更改dfd的状态。这是你可以返回一个针对dfd的promise对象。<br/>
        promise是dfd的只读版，可以理解成是一个对将要完成的任务的承诺。<br/><br/>

        你可以通过promise为原始的dfd对象添加回调函数，查询他的状态，但是无法改变他的状态，<br/>
        也就是说不允许promise调用resolve和reject方法。<br/>
    </p>

    <h3>$.when()</h3>
    <p>
        作用：<br/>
        接受多个dfd对象作为参数，当它们全部都是成功状态时才调用resolved状态的回调函数。<br/>
        相当于将多个非同步操作合并成一个。<br/>
        回调函数的参数是，依次是对相应的dfd的返回值。
    </p>
    <pre>
        $.when(
            $.ajax("1.php"),
            $.ajax("2.php"),
            $.ajax("3.php")
        ).then(successFun,failFun);
    </pre>

</div>
</body>
</html>
